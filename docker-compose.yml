version: '3.8'

services:
  mongodb:
    image: mongo:7.0
    container_name: malice-mongo
    restart: unless-stopped
    ports:
      - "27017:27017"
    volumes:
      - mongodb_data:/data/db
    environment:
      - MONGO_INITDB_DATABASE=malice
    command: ["--replSet", "rs0", "--bind_ip_all"]
    networks:
      - malice-network
    healthcheck:
      test: ["CMD-SHELL", "mongosh --eval 'db.adminCommand(\"ping\")' --quiet || exit 1"]
      interval: 5s
      timeout: 5s
      retries: 20
      start_period: 30s

  mongo-init:
    image: mongo:7.0
    container_name: malice-mongo-init
    restart: "no"
    depends_on:
      mongodb:
        condition: service_healthy
    entrypoint: ["sh", "-c"]
    command:
      - |
        for i in 1 2 3 4 5; do
          echo "Attempt $$i to initialize replica set..."
          result=$$(mongosh --host mongodb:27017 --quiet --eval 'try{var s=rs.status();if(s.ok)print("OK");else print("INIT")}catch(e){print("INIT")}' 2>&1)
          echo "Result: $$result"
          if [ "$$result" = "OK" ]; then
            echo "Replica set already initialized"
            exit 0
          fi
          echo "Initializing replica set..."
          mongosh --host mongodb:27017 --eval 'rs.initiate({_id:"rs0",members:[{_id:0,host:"mongodb:27017"}]})' 2>&1 && exit 0
          echo "Failed, retrying in 3 seconds..."
          sleep 3
        done
        echo "Failed to initialize replica set after 5 attempts"
        exit 1
    networks:
      - malice-network

  game:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: malice-game
    restart: unless-stopped
    ports:
      - "5555:5555"  # Telnet
      - "8080:8080"  # WebSocket
      - "3001:3001"  # MCP
    environment:
      - MONGO_URI=mongodb://mongodb:27017
      - NODE_ENV=production
    depends_on:
      mongodb:
        condition: service_healthy
      mongo-init:
        condition: service_completed_successfully
    networks:
      - malice-network

volumes:
  mongodb_data:
    driver: local

networks:
  malice-network:
    driver: bridge
